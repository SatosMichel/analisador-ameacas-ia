<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Ameaças STRIDE</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; padding: 2em; }
        .container { width: 100%; max-width: 960px; }
        h1, h2 { color: #ffffff; border-bottom: 2px solid #0D6EFD; padding-bottom: 10px; }
        .upload-area { background-color: #1e1e1e; border: 2px dashed #444; border-radius: 8px; padding: 2em; text-align: center; margin-bottom: 2em; }
        .upload-area:hover { border-color: #0D6EFD; }
        #imageUpload { display: none; }
        .upload-label { cursor: pointer; font-weight: bold; color: #0D6EFD; }
        button { background-color: #0D6EFD; color: white; border: none; padding: 12px 24px; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        #fileName { margin-top: 1em; color: #aaa; }
        #loader { display: none; text-align: center; margin: 2em; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #0D6EFD; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        table { width: 100%; border-collapse: collapse; margin-top: 1em; background-color: #1e1e1e; }
        th, td { border: 1px solid #444; padding: 12px; text-align: left; }
        th { background-color: #2a2a2a; color: #0D6EFD; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Análise de Ameaças STRIDE com IA</h1>
        <p>Faça o upload de um diagrama de arquitetura para gerar uma análise de ameaças automática.</p>
        
        <form id="uploadForm">
            <div class="upload-area">
                <label for="imageUpload" class="upload-label">Clique aqui para selecionar uma imagem</label>
                <input type="file" id="imageUpload" name="file" accept="image/*">
                <p id="fileName"></p>
            </div>
            <button type="submit" id="analyzeButton" disabled>Analisar</button>
        </form>

        <div id="loader">
            <div class="spinner"></div>
            <p>Analisando arquitetura... Isso pode levar um momento.</p>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const imageUpload = document.getElementById('imageUpload');
        const analyzeButton = document.getElementById('analyzeButton');
        const fileNameDisplay = document.getElementById('fileName');
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');

        let selectedFile = null;

        imageUpload.addEventListener('change', (event) => {
            selectedFile = event.target.files[0];
            if (selectedFile) {
                fileNameDisplay.textContent = `Arquivo selecionado: ${selectedFile.name}`;
                analyzeButton.disabled = false;
            } else {
                fileNameDisplay.textContent = '';
                analyzeButton.disabled = true;
            }
        });

        uploadForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (!selectedFile) return;

            resultsDiv.innerHTML = '';
            loader.style.display = 'block';
            analyzeButton.disabled = true;

            const formData = new FormData();
            formData.append('file', selectedFile);

            try {
                // A URL aponta para a nossa API FastAPI
                const response = await fetch('/analyze', {
                    method: 'POST',
                    body: formData,
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.statusText}`);
                }

                const data = await response.json();
                displayResults(data);

            } catch (error) {
                resultsDiv.innerHTML = `<p style="color: red;">Ocorreu um erro: ${error.message}</p>`;
            } finally {
                loader.style.display = 'none';
                analyzeButton.disabled = false;
            }
        });

        function displayResults(data) {
            let html = '<h2>Resultado da Análise STRIDE</h2>';
            const categoryOrder = ["spoofing", "tampering", "repudiation", "information_disclosure", "denial_of_service", "elevation_of_privilege"];
            
            for (const category of categoryOrder) {
                if(data[category]) {
                    const threats = data[category];
                    const categoryTitle = category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<h3>${categoryTitle}</h3>`;
                    
                    if (threats.length > 0) {
                        html += `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ameaça Potencial</th>
                                        <th>Mitigação Sugerida</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        threats.forEach(item => {
                            html += `
                                <tr>
                                    <td>${item.threat}</td>
                                    <td>${item.mitigation}</td>
                                </tr>
                            `;
                        });
                        html += '</tbody></table>';
                    } else {
                        html += '<p>Nenhuma ameaça específica identificada para esta categoria.</p>';
                    }
                }
            }
            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>